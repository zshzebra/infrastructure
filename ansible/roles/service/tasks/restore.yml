---
# Restore task - included by playbooks
# Required vars: service_name, service, snapshot_id (default: latest)

- name: Set snapshot ID
  ansible.builtin.set_fact:
    restore_snapshot: "{{ snapshot_id | default('latest') }}"

- name: Create restore staging directory
  ansible.builtin.file:
    path: "{{ backup_base_path }}/staging/{{ service_name }}"
    state: directory
    mode: "0755"

- name: Restore from restic
  ansible.builtin.command:
    cmd: >
      restic restore {{ restore_snapshot }}
      --target {{ backup_base_path }}/staging/{{ service_name }}
      --tag {{ service_name }}
  environment:
    RESTIC_REPOSITORY: "{{ restic_repository }}"
    RESTIC_PASSWORD: "{{ restic_password }}"
    AWS_ACCESS_KEY_ID: "{{ s3_access_key }}"
    AWS_SECRET_ACCESS_KEY: "{{ s3_secret_key }}"
  register: restore_result

- name: Create service directory
  ansible.builtin.file:
    path: "{{ service.path }}"
    state: directory
    mode: "0755"

- name: Create bind mount directories
  ansible.builtin.file:
    path: "{{ service.path }}/{{ item.source | regex_replace('^\\./', '') }}"
    state: directory
    mode: "0755"
  loop: "{{ service.volumes | selectattr('type', 'equalto', 'bind') | list }}"
  when: service.volumes is defined

# Restore bind mount volumes
- name: Restore bind mount volumes
  ansible.builtin.copy:
    src: "{{ backup_base_path }}/staging/{{ service_name }}/opt/backups/staging/{{ service_name }}/{{ item.backup_path }}/"
    dest: "{{ service.path }}/{{ item.source | regex_replace('^\\./', '') }}/"
    remote_src: true
    mode: preserve
  loop: "{{ service.volumes | selectattr('type', 'equalto', 'bind') | list }}"
  when: service.volumes is defined

# Restore named volumes
- name: Restore named volumes
  community.docker.docker_container:
    name: "restore-{{ item.name | replace('_', '-') }}"
    image: alpine
    command: "sh -c 'cp -a /backup/* /volume/ 2>/dev/null || true'"
    volumes:
      - "{{ item.name }}:/volume"
      - "{{ backup_base_path }}/staging/{{ service_name }}/opt/backups/staging/{{ service_name }}/{{ item.backup_path }}:/backup:ro"
    state: started
    detach: false
    auto_remove: true
  loop: "{{ service.volumes | selectattr('type', 'equalto', 'named') | list }}"
  when: service.volumes is defined

- name: Cleanup staging directory
  ansible.builtin.file:
    path: "{{ backup_base_path }}/staging/{{ service_name }}"
    state: absent
